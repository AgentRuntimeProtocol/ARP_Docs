stages:
  - build
  - deploy

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_COMMIT_BRANCH

build:
  stage: build
  image: node:20
  script:
    - npm ci --no-audit --no-fund
    - npm run build
    - npm run typecheck
  artifacts:
    paths:
      - build/
    expire_in: 1 week

deploy:
  stage: deploy
  image: amazon/aws-cli:2
  dependencies:
    - build
  id_tokens:
    AWS_ID_TOKEN:
      aud: https://gitlab.com
  script:
    - set -euo pipefail
    - |
      if [ -z "${AWS_ROLE_ARN:-}" ]; then
        echo "Missing required variable: AWS_ROLE_ARN" >&2
        exit 1
      fi
      if [ -z "${AWS_REGION:-}" ]; then
        echo "Missing required variable: AWS_REGION" >&2
        exit 1
      fi
      if [ -z "${AWS_S3_BUCKET:-}" ]; then
        echo "Missing required variable: AWS_S3_BUCKET" >&2
        exit 1
      fi
      if [ -z "${AWS_CLOUDFRONT_DISTRIBUTION_ID:-}" ]; then
        echo "Missing required variable: AWS_CLOUDFRONT_DISTRIBUTION_ID" >&2
        exit 1
      fi
    - export AWS_DEFAULT_REGION="${AWS_REGION}"
    - |
      read AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN <<EOF
      $(aws sts assume-role-with-web-identity \
        --role-arn "${AWS_ROLE_ARN}" \
        --role-session-name "gitlab-${CI_PROJECT_NAME}-${CI_PIPELINE_ID}" \
        --web-identity-token "${AWS_ID_TOKEN}" \
        --duration-seconds 3600 \
        --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' \
        --output text)
      EOF
    - export AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN
    - aws s3 sync build/ "s3://${AWS_S3_BUCKET}/public_docs/" --delete
    - aws cloudfront create-invalidation --distribution-id "${AWS_CLOUDFRONT_DISTRIBUTION_ID}" --paths "/public_docs*"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
    - when: never
